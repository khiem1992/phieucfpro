<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHIẾU THU INTERNET</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen p-4 sm:p-8">
    
    <!-- Toast/Notification Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3"></div>

    <div class="max-w-4xl mx-auto">
        
        <!-- HEADER -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800 tracking-tight">
                PHIẾU THU INTERNET
            </h1>
            <p class="mt-2 text-lg text-gray-500">Quản lý giao dịch và cập nhật trạng thái khách hàng</p>
        </header>

        <!-- Form Container -->
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100">
            <form id="payment-form" class="space-y-6">
                
                <!-- KHỐI 1: THÔNG TIN KHÁCH HÀNG -->
                <div class="space-y-4 p-4 bg-blue-50/50 rounded-lg border border-blue-100 shadow-inner">
                    <h2 class="text-xl font-bold text-blue-700 border-b pb-2">1. Chọn/Nhập Khách Hàng</h2>
                    
                    <div>
                        <label for="tenKH" class="block text-sm font-medium text-gray-700">Tên Khách Hàng (Tên KH)<span class="text-red-500">*</span></label>
                        <input type="text" id="tenKH" name="tenKH" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                </div>

                <!-- KHỐI 2: THÔNG TIN GÓI CƯỚC & THANH TOÁN -->
                <div class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-2">2. Chi Tiết Giao Dịch</h2>
                    
                    <!-- Dòng 1: Giá 1 tháng & Số tháng -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="gia1Thang" class="block text-sm font-medium text-gray-700">Giá Gói 1 Tháng (VNĐ)</label>
                            <input type="text" id="gia1Thang" name="gia1Thang" value="200.000"
                                   class="currency-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 transition duration-150"
                                   oninput="formatCurrencyInput(this); calculateExpiryAndPromo()">
                        </div>
                        
                        <div>
                            <label for="soThang" class="block text-sm font-medium text-gray-700">Số Tháng Nộp<span class="text-red-500">*</span></label>
                            <input type="number" id="soThang" name="soThang" value="1" min="1" required
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                   oninput="calculateExpiryAndPromo()">
                        </div>
                    </div>
                    
                    <!-- Dòng 2: Giá KM & Số tiền nộp -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="giaKhuyenMai" class="block text-sm font-medium text-gray-700">Giá Khuyến Mại (Nếu có)</label>
                            <input type="text" id="giaKhuyenMai" name="giaKhuyenMai" value="0"
                                   class="currency-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 transition duration-150"
                                   oninput="formatCurrencyInput(this); calculateExpiryAndPromo()">
                        </div>
                        
                        <div>
                            <label for="soTienNop" class="block text-sm font-medium text-gray-700">Số Tiền Nộp Thực Tế (VNĐ)<span class="text-red-500">*</span></label>
                            <input type="text" id="soTienNop" name="soTienNop" required
                                   class="currency-input mt-1 block w-full px-4 py-2 border border-red-300 rounded-lg shadow-lg bg-red-50 text-xl font-semibold text-red-700 focus:ring-red-500 focus:border-red-500 transition duration-150"
                                   oninput="formatCurrencyInput(this)">
                        </div>
                    </div>
                    
                    <!-- Dòng 3: Hạn dùng mới (Tự tính toán) -->
                    <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                        <label for="hanDungMoi" class="block text-sm font-medium text-green-700">Hạn Dùng Mới (Dự kiến)</label>
                        <input type="text" id="hanDungMoi" name="hanDungMoi" readonly
                               class="mt-1 block w-full px-4 py-2 border-none bg-transparent text-lg font-bold text-green-800">
                    </div>

                    <!-- Dòng 4: Ghi chú -->
                    <div>
                        <label for="ghiChu" class="block text-sm font-medium text-gray-700">Ghi Chú</label>
                        <textarea id="ghiChu" name="ghiChu" rows="2"
                                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"></textarea>
                    </div>
                </div>

                <!-- Footer và nút Gửi -->
                <div class="pt-4 border-t">
                    <button type="submit" id="submit-button"
                            class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-xl text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:bg-gray-400">
                        <span id="submit-text">Nộp Tiền & Ghi Lịch Sử</span>
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <p class="mt-3 text-xs text-center text-gray-400">Dữ liệu sẽ được ghi vào Google Sheet qua Apps Script API.</p>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Cấu hình URL API Apps Script của bạn
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdopg4oy9QDynuxq2-4-kypJ8-bJrjm8NkY1RxUNeaPKZYFime_FZEhnVEAFTCgyqb/exec'; // <--- THAY THẾ URL ĐÃ TRIỂN KHAI CỦA BẠN TẠI ĐÂY

        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-button');
        const submitText = document.getElementById('submit-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const soThangInput = document.getElementById('soThang');
        const hanDungMoiInput = document.getElementById('hanDungMoi');
        const gia1ThangInput = document.getElementById('gia1Thang');
        const giaKhuyenMaiInput = document.getElementById('giaKhuyenMai');
        const soTienNopInput = document.getElementById('soTienNop');

        /**
         * Định dạng số tiền thành chuỗi tiền tệ (dấu chấm phân cách nghìn).
         * @param {number} number Số tiền.
         * @returns {string} Chuỗi tiền tệ.
         */
        function formatVND(number) {
            if (isNaN(number)) return '';
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' VNĐ';
        }

        /**
         * Lấy giá trị số từ chuỗi tiền tệ (loại bỏ dấu chấm, VNĐ).
         * @param {string} value Chuỗi tiền tệ.
         * @returns {number} Giá trị số.
         */
        function parseVND(value) {
            if (!value) return 0;
            // Loại bỏ tất cả ký tự không phải số (trừ dấu chấm thập phân, nhưng ở VNĐ ta chỉ có dấu chấm cho nghìn)
            const cleaned = value.replace(/[^0-9]/g, ''); 
            return parseInt(cleaned, 10) || 0;
        }

        /**
         * Định dạng tiền tệ cho input khi người dùng nhập.
         * @param {HTMLInputElement} input Element input.
         */
        function formatCurrencyInput(input) {
            const num = parseVND(input.value);
            input.value = formatVND(num).replace(' VNĐ', '');
        }

        /**
         * Tính toán Hạn dùng mới và Số tiền nộp dự kiến (Tổng tiền gói - Khuyến mại).
         */
        function calculateExpiryAndPromo() {
            const soThang = parseInt(soThangInput.value) || 0;
            const gia1Thang = parseVND(gia1ThangInput.value);
            const giaKhuyenMai = parseVND(giaKhuyenMaiInput.value);
            
            // Tính toán Hạn Dùng Mới
            const currentDate = new Date();
            const newExpiryDate = new Date(currentDate);
            newExpiryDate.setMonth(currentDate.getMonth() + soThang);
            
            // Định dạng Hạn Dùng Mới (dd/MM/yyyy)
            const day = String(newExpiryDate.getDate()).padStart(2, '0');
            const month = String(newExpiryDate.getMonth() + 1).padStart(2, '0'); // Tháng bắt đầu từ 0
            const year = newExpiryDate.getFullYear();
            hanDungMoiInput.value = `${day}/${month}/${year}`;

            // Tính toán Số Tiền Nộp mặc định (cho người dùng tham khảo)
            const tongGiaGoi = gia1Thang * soThang;
            const soTienNopDuKien = tongGiaGoi - giaKhuyenMai;
            
            // Cập nhật số tiền nộp nếu chưa có
            if (parseVND(soTienNopInput.value) === 0) {
                 soTienNopInput.value = formatVND(soTienNopDuKien).replace(' VNĐ', '');
            }
        }
        
        // Khởi chạy tính toán ban đầu
        window.onload = () => {
             calculateExpiryAndPromo();
             // Định dạng lại các ô tiền tệ khi tải trang
             document.querySelectorAll('.currency-input').forEach(input => formatCurrencyInput(input));
        };
        

        /**
         * Hiển thị thông báo (toast) cho người dùng.
         * @param {string} message Nội dung thông báo.
         * @param {string} type Loại thông báo ('success', 'error', 'info').
         */
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const baseClasses = "p-4 rounded-lg shadow-xl text-white font-medium flex items-center";
            let colorClasses = "";
            let iconSvg = "";

            if (type === 'success') {
                colorClasses = "bg-green-500";
                iconSvg = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else if (type === 'error') {
                colorClasses = "bg-red-600";
                iconSvg = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else {
                colorClasses = "bg-blue-500";
                iconSvg = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            }

            const toast = document.createElement('div');
            toast.className = `${baseClasses} ${colorClasses} transform translate-x-full transition duration-500 ease-out`;
            toast.innerHTML = `${iconSvg} <span>${message}</span>`;
            
            container.appendChild(toast);

            // Hiện toast
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
            }, 10);

            // Tự động ẩn toast sau 5 giây
            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        /**
         * Xử lý gửi dữ liệu qua API Apps Script.
         */
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (APPS_SCRIPT_URL === 'YOUR_DEPLOYED_APPS_SCRIPT_URL') {
                showToast('Lỗi cấu hình: Vui lòng thay thế YOUR_DEPLOYED_APPS_SCRIPT_URL bằng URL Apps Script thực tế.', 'error');
                return;
            }

            // Bắt đầu loading
            submitButton.disabled = true;
            submitText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            const soTienNopValue = parseVND(soTienNopInput.value);
            const gia1ThangValue = parseVND(gia1ThangInput.value);
            const giaKhuyenMaiValue = parseVND(giaKhuyenMaiInput.value);
            
            // Chuẩn bị dữ liệu gửi đi
            const formData = {
                tenKH: document.getElementById('tenKH').value.trim(),
                soTienNop: soTienNopValue, 
                hanDungMoi: hanDungMoiInput.value, // dd/MM/yyyy
                gia1Thang: gia1ThangValue,
                soThang: soThangInput.value,
                giaKhuyenMai: giaKhuyenMaiValue,
                ghiChu: document.getElementById('ghiChu').value
            };
            
            if (!formData.tenKH) {
                showToast('Vui lòng nhập Tên Khách Hàng.', 'error');
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                return;
            }
            if (formData.soTienNop <= 0) {
                showToast('Số Tiền Nộp phải lớn hơn 0.', 'error');
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                return;
            }


            let success = false;
            let responseMessage = 'Không có phản hồi từ API.';
            const MAX_RETRIES = 3;
            let delay = 1000;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData),
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        success = true;
                        responseMessage = result.message || 'Giao dịch thành công.';
                        break; // Thành công, thoát vòng lặp
                    } else {
                        responseMessage = result.message || 'Lỗi không xác định từ Apps Script.';
                        throw new Error(responseMessage);
                    }
                } catch (error) {
                    console.error('Lỗi API:', error);
                    if (i < MAX_RETRIES - 1) {
                        // Retry with exponential backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        responseMessage = `Thất bại sau ${MAX_RETRIES} lần thử: ${error.message}`;
                    }
                }
            }

            // Kết thúc loading
            submitButton.disabled = false;
            submitText.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');

            // Hiển thị kết quả
            if (success) {
                showToast(responseMessage, 'success');
                // Tùy chọn: Reset form sau khi gửi thành công
                form.reset();
                // Thiết lập lại giá trị mặc định cho ô tiền tệ sau reset
                gia1ThangInput.value = formatVND(200000).replace(' VNĐ', '');
                giaKhuyenMaiInput.value = formatVND(0).replace(' VNĐ', '');
                calculateExpiryAndPromo();
            } else {
                showToast(responseMessage, 'error');
            }
        });

        // Thiết lập sự kiện tính toán khi thay đổi các trường liên quan
        document.getElementById('soThang').addEventListener('input', calculateExpiryAndPromo);
        document.getElementById('gia1Thang').addEventListener('input', calculateExpiryAndPromo);
        document.getElementById('giaKhuyenMai').addEventListener('input', calculateExpiryAndPromo);

    </script>
</body>
</html>
