<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Phi·∫øu Thu Internet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-lg">
    <h2 class="text-center text-2xl font-bold mb-4">PHI·∫æU THU INTERNET</h2>

    <!-- KHI LOAD -->
    <div id="loading" class="flex flex-col items-center justify-center py-10">
      <div class="loader"></div>
      <p class="mt-3 text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <!-- CH·ªåN KH√ÅCH H√ÄNG -->
    <div id="main-content" class="hidden">
      <label class="block mb-2 font-medium">1. Ch·ªçn Kh√°ch H√†ng</label>
      <div class="flex gap-2">
        <select id="customerSelect" class="flex-1 border rounded-lg p-2">
          <option value="">-- Ch·ªçn T√™n Kh√°ch H√†ng --</option>
        </select>
        <button onclick="openModal()" class="bg-green-500 text-white px-4 rounded-lg">+</button>
      </div>

      <div id="infoBox" class="mt-4 text-sm text-gray-700"></div>

      <button onclick="submitPayment()" id="submitBtn"
        class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg">
        üí≥ X√°c Nh·∫≠n N·ªôp Ti·ªÅn
      </button>
    </div>
  </div>

  <!-- MODAL TH√äM KH√ÅCH H√ÄNG -->
  <div id="modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-sm">
      <h3 class="text-lg font-bold mb-3">Th√™m Kh√°ch H√†ng M·ªõi</h3>
      <input id="newName" placeholder="T√™n Kh√°ch H√†ng" class="w-full border p-2 mb-2 rounded" />
      <input id="newPackage" placeholder="G√≥i C∆∞·ªõc (VNƒê/th√°ng)" class="w-full border p-2 mb-2 rounded" />
      <input id="newPaid" placeholder="Ti·ªÅn N·ªôp Ban ƒê·∫ßu" class="w-full border p-2 mb-2 rounded" />
      <input id="newExpired" placeholder="H·∫°n D√πng (dd/mm/yyyy)" class="w-full border p-2 mb-2 rounded" />
      <textarea id="newNote" placeholder="Ghi ch√∫" class="w-full border p-2 mb-2 rounded"></textarea>
      <div class="flex gap-2">
        <button onclick="saveCustomer()" class="flex-1 bg-green-600 text-white py-2 rounded">L∆∞u</button>
        <button onclick="closeModal()" class="flex-1 bg-gray-400 text-white py-2 rounded">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycby-KvEIPOZ2H1xnw0st_JNvP8xiMqUIYv7s6kv4AXgawNTAdG1Om3G_u1HdHK_qilLq/exec";

    function formatDate(dateString) {
      if (!dateString) return "-";
      const d = new Date(dateString);
      if (isNaN(d)) return "-";
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    async function loadCustomers() {
      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("main-content").classList.add("hidden");

      try {
        const res = await google.script.run.withSuccessHandler(customers => {
          const select = document.getElementById("customerSelect");
          select.innerHTML = '<option value="">-- Ch·ªçn T√™n Kh√°ch H√†ng --</option>';
          customers.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.name;
            opt.textContent = c.name;
            select.appendChild(opt);
          });
          document.getElementById("loading").classList.add("hidden");
          document.getElementById("main-content").classList.remove("hidden");
        }).getCustomerList();
      } catch (e) {
        alert("L·ªói t·∫£i d·ªØ li·ªáu: " + e.message);
      }
    }

    function openModal() {
      document.getElementById("modal").classList.remove("hidden");
    }
    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
    }

    function saveCustomer() {
      const data = {
        name: newName.value.trim(),
        package: newPackage.value,
        firstPaid: newPaid.value,
        expiredDate: newExpired.value,
        note: newNote.value
      };
      google.script.run.withSuccessHandler(msg => {
        alert(msg);
        closeModal();
        loadCustomers();
      }).addCustomer(data);
    }

    async function submitPayment() {
      const name = document.getElementById("customerSelect").value;
      if (!name) return alert("Ch·ªçn kh√°ch h√†ng tr∆∞·ªõc!");

      const note = prompt("Nh·∫≠p ghi ch√∫ (n·∫øu c√≥):", "");
      const amount = Number(prompt("Nh·∫≠p s·ªë ti·ªÅn n·ªôp:", "700000"));
      if (!amount) return;

      document.getElementById("submitBtn").disabled = true;
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ name, amount, note }),
        headers: { "Content-Type": "application/json" }
      });
      const result = await res.json();

      if (result.success) alert("‚úÖ N·ªôp ti·ªÅn th√†nh c√¥ng!");
      else alert("‚ùå " + result.message);
      document.getElementById("submitBtn").disabled = false;
      loadCustomers();
    }

    loadCustomers();
  </script>
</body>
</html>
