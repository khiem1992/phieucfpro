<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Thu Internet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Simple spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-8">
        <h1 class="text-2xl font-bold text-center text-gray-800">PHIẾU THU INTERNET</h1>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="loader"></div>
        </div>
        
        <!-- Notification -->
        <div id="notification" class="hidden p-4 rounded-lg text-white font-medium mb-4"></div>

        <!-- Khối 1: Chọn khách hàng -->
        <div id="customer-block" class="space-y-4">
            <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">1. Chọn khách hàng</h2>
            <div class="flex items-center space-x-3">
                <select id="customer-select" class="block w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <option>Đang tải danh sách...</option>
                </select>
                <button id="add-customer-btn" class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition shadow-sm flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
            </div>
            <div id="package-info" class="text-sm text-gray-500 h-5"></div>
        </div>

        <!-- Khối 2: Cập nhật thanh toán -->
        <div id="payment-block" class="space-y-4 hidden">
            <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">2. Cập nhật thanh toán</h2>
            <div>
                <label for="amount-input" class="block text-sm font-medium text-gray-700 mb-1">Số tiền nộp (vnđ)</label>
                <input type="tel" id="amount-input" placeholder="Nhập số tiền" class="block w-full p-3 border-2 border-blue-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg font-semibold">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Hạn dùng mới (dự kiến)</label>
                <div id="new-expiry-date" class="p-3 bg-green-100 text-green-800 font-bold rounded-lg text-center">
                    -
                </div>
            </div>
             <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Số tháng gia hạn</label>
                <div id="months-added" class="p-3 bg-gray-100 text-gray-800 font-bold rounded-lg text-center">
                    -
                </div>
            </div>
            <div>
                <label for="notes-input" class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
                <input type="text" id="notes-input" class="block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <button id="submit-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition shadow-md disabled:bg-gray-400 hidden">
            Xác Nhận Nộp Tiền
        </button>

        <!-- Khối 3: Thông tin khách hàng -->
        <div id="history-block" class="space-y-2 pt-4 border-t hidden">
             <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">3. Thông tin khách hàng</h2>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <span class="font-medium text-gray-600">Hạn dùng hiện tại:</span>
                <span id="history-expiry" class="font-bold text-lg text-red-600"></span>
                <span class="font-medium text-gray-600">Ngày nộp (lần trước):</span>
                <span id="history-payment-date"></span>
                <span class="font-medium text-gray-600">Số tiền nộp trước:</span>
                <span id="history-amount"></span>
                 <span class="font-medium text-gray-600">Giá 12 tháng:</span>
                <span id="history-promo-price"></span>
                <span class="font-medium text-gray-600">Ghi chú:</span>
                <span id="history-notes" class="truncate"></span>
            </div>
        </div>
    </div>

    <!-- Modal Thêm Khách Hàng Mới -->
    <div id="add-customer-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-md m-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Thêm Khách Hàng Mới</h2>
            <form id="new-customer-form" class="space-y-4">
                <div>
                    <label for="new-name" class="block text-sm font-medium text-gray-700">Tên khách hàng</label>
                    <input type="text" id="new-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div>
                    <label for="new-monthly-price" class="block text-sm font-medium text-gray-700">Giá 1 tháng (vnđ)</label>
                    <input type="tel" id="new-monthly-price" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                 <div>
                    <label for="new-promo-price" class="block text-sm font-medium text-gray-700">Giá 12 tháng (vnđ)</label>
                    <input type="tel" id="new-promo-price" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div>
                    <label for="new-initial-amount" class="block text-sm font-medium text-gray-700">Số tiền nộp ban đầu (vnđ)</label>
                    <input type="tel" id="new-initial-amount" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div>
                    <label for="new-start-date" class="block text-sm font-medium text-gray-700">Hạn sử dụng ban đầu</label>
                    <input type="date" id="new-start-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div>
                    <label for="new-notes" class="block text-sm font-medium text-gray-700">Ghi chú</label>
                    <input type="text" id="new-notes" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-modal-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Hủy</button>
                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Tạo Mới</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // ===================================================================================
        // !!! QUAN TRỌNG: Dán URL Google Apps Script của bạn vào đây !!!
        // ===================================================================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyqkYs9Juct1QOVdqpwDE6KY7J-rRPDgNsYUZ1VNXCCsrJOGfktavCSVf3dINsxD0qQ/exec';
        // ===================================================================================

        // --- DOM Elements ---
        const customerSelect = document.getElementById('customer-select');
        const packageInfo = document.getElementById('package-info');
        const paymentBlock = document.getElementById('payment-block');
        const historyBlock = document.getElementById('history-block');
        const amountInput = document.getElementById('amount-input');
        const newExpiryDateEl = document.getElementById('new-expiry-date');
        const monthsAddedEl = document.getElementById('months-added');
        const notesInput = document.getElementById('notes-input');
        const submitBtn = document.getElementById('submit-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const notification = document.getElementById('notification');
        
        // --- History Elements ---
        const historyExpiry = document.getElementById('history-expiry');
        const historyPaymentDate = document.getElementById('history-payment-date');
        const historyAmount = document.getElementById('history-amount');
        const historyPromoPrice = document.getElementById('history-promo-price');
        const historyNotes = document.getElementById('history-notes');

        // --- Modal Elements ---
        const addCustomerBtn = document.getElementById('add-customer-btn');
        const modal = document.getElementById('add-customer-modal');
        const newCustomerForm = document.getElementById('new-customer-form');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const newMonthlyPriceInput = document.getElementById('new-monthly-price');
        const newPromoPriceInput = document.getElementById('new-promo-price');
        const newInitialAmountInput = document.getElementById('new-initial-amount');

        // --- State ---
        let customers = [];
        let selectedCustomer = null;

        // --- Helper Functions ---
        const formatCurrency = (num) => num === 0 ? '0' : (num ? new Intl.NumberFormat('vi-VN').format(num) : '');
        const parseCurrency = (str) => parseInt(String(str).replace(/[^\d]/g, ''), 10) || 0;
        const formatDate = (date) => {
            if (!date) return 'N/A';
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        };
        const formatDateTime = (date) => {
             if (!date) return 'N/A';
            const d = new Date(date);
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes} ${formatDate(d)}`;
        }

        const showLoading = (isLoading) => {
            loadingOverlay.classList.toggle('hidden', !isLoading);
            document.querySelectorAll('button, input, select').forEach(el => el.disabled = isLoading);
        };
        
        const showNotification = (message, isSuccess = true) => {
            notification.textContent = message;
            notification.className = `p-4 rounded-lg text-white font-medium mb-4 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        };

        // --- Core Functions ---
        const fetchCustomers = async () => {
            showLoading(true);
            try {
                if (SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    throw new Error("Vui lòng cấu hình URL của Google Apps Script.");
                }
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error('Không thể tải dữ liệu từ Google Sheet.');
                customers = await response.json();
                populateCustomerDropdown();
            } catch (error) {
                showNotification(error.message, false);
                customerSelect.innerHTML = `<option value="">Lỗi tải dữ liệu</option>`;
            } finally {
                showLoading(false);
            }
        };

        const populateCustomerDropdown = () => {
            customerSelect.innerHTML = '<option value="">-- Chọn khách hàng --</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.tenKH;
                option.textContent = customer.tenKH;
                customerSelect.appendChild(option);
            });
        };

        const displayCustomerInfo = (customerName) => {
            selectedCustomer = customers.find(c => c.tenKH === customerName);
            if (selectedCustomer) {
                packageInfo.textContent = `Gói cước: ${formatCurrency(selectedCustomer.giaThang)} vnđ/tháng`;
                historyExpiry.textContent = formatDate(selectedCustomer.hanDung);
                historyPaymentDate.textContent = formatDateTime(selectedCustomer.ngayNop);
                historyAmount.textContent = `${formatCurrency(selectedCustomer.soTienNop)} vnđ`;
                historyPromoPrice.textContent = `${formatCurrency(selectedCustomer.giaKhuyenMai)} vnđ`;
                historyNotes.textContent = selectedCustomer.ghiChu || '-';

                paymentBlock.classList.remove('hidden');
                historyBlock.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
                resetPaymentForm();
            } else {
                packageInfo.textContent = '';
                paymentBlock.classList.add('hidden');
                historyBlock.classList.add('hidden');
                submitBtn.classList.add('hidden');
                selectedCustomer = null;
            }
        };
        
        const resetPaymentForm = () => {
            amountInput.value = '';
            notesInput.value = '';
            newExpiryDateEl.textContent = '-';
            monthsAddedEl.textContent = '-';
        }

        const calculateNewExpiry = () => {
            if (!selectedCustomer) return;
            
            const amount = parseCurrency(amountInput.value);
            const monthlyPrice = selectedCustomer.giaThang;
            const promoPrice = selectedCustomer.giaKhuyenMai;
            const currentExpiry = new Date(selectedCustomer.hanDung);

            if (isNaN(currentExpiry.getTime())) {
                newExpiryDateEl.textContent = "Hạn dùng hiện tại không hợp lệ";
                monthsAddedEl.textContent = '0';
                return;
            }

            let monthsToAdd = 0;
            if (amount > 0 && monthlyPrice > 0) {
                 if (promoPrice > 0 && amount === promoPrice) {
                    monthsToAdd = 12;
                } else {
                    monthsToAdd = Math.floor(amount / monthlyPrice);
                }
            }

            if (monthsToAdd > 0) {
                const newDate = new Date(currentExpiry.getFullYear(), currentExpiry.getMonth() + monthsToAdd + 1, 0);
                newExpiryDateEl.textContent = formatDate(newDate);
            } else {
                newExpiryDateEl.textContent = '-';
            }
            monthsAddedEl.textContent = monthsToAdd;
        };

        const handlePaymentSubmit = async () => {
            if (!selectedCustomer) {
                showNotification('Vui lòng chọn một khách hàng.', false);
                return;
            }
            const amount = parseCurrency(amountInput.value);
            if (amount <= 0) {
                showNotification('Số tiền nộp phải lớn hơn 0.', false);
                return;
            }

            showLoading(true);

            // Re-calculate to ensure data is correct before sending
            const monthlyPrice = selectedCustomer.giaThang;
            const promoPrice = selectedCustomer.giaKhuyenMai;
            const currentExpiry = new Date(selectedCustomer.hanDung);
            let monthsToAdd = 0;
            if (promoPrice > 0 && amount === promoPrice) {
                monthsToAdd = 12;
            } else {
                monthsToAdd = Math.floor(amount / monthlyPrice);
            }
            const finalExpiryDate = new Date(currentExpiry.getFullYear(), currentExpiry.getMonth() + monthsToAdd + 1, 0);

            const payload = {
                action: 'update',
                tenKH: selectedCustomer.tenKH,
                soTienNop: amount,
                hanDungMoi: finalExpiryDate.toISOString(),
                soThang: monthsToAdd,
                ghiChu: notesInput.value,
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showNotification(`Đã nộp tiền cho ${selectedCustomer.tenKH}, hạn dùng mới đến ${formatDate(finalExpiryDate)}.`);
                    await fetchCustomers(); // Refresh data
                    customerSelect.value = selectedCustomer.tenKH; // Re-select current customer
                    displayCustomerInfo(selectedCustomer.tenKH); // Refresh UI
                } else {
                    throw new Error(result.message || 'Có lỗi xảy ra.');
                }
            } catch (error) {
                showNotification(`Lỗi: ${error.message}`, false);
            } finally {
                showLoading(false);
            }
        };

        const handleNewCustomerSubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const tenKH = formData.get('name');
            const soTienNop = parseCurrency(formData.get('new-initial-amount'));
            const giaThang = parseCurrency(formData.get('new-monthly-price'));
            const giaKhuyenMai = parseCurrency(formData.get('new-promo-price'));
            const ghiChu = formData.get('new-notes');
            const startDateStr = formData.get('new-start-date');

            if (soTienNop <= 0 || giaThang <= 0) {
                 showNotification('Số tiền và giá cước phải lớn hơn 0.', false);
                 return;
            }
            
            const startDate = new Date(startDateStr);
            const monthsToAdd = Math.floor(soTienNop / giaThang);
            // Hạn dùng ban đầu sẽ là ngày cuối của tháng bắt đầu
            const initialExpiryDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
            const finalExpiryDate = new Date(initialExpiryDate.getFullYear(), initialExpiryDate.getMonth() + monthsToAdd, initialExpiryDate.getDate());

            const payload = {
                action: 'create',
                tenKH: tenKH,
                soTienNop: soTienNop,
                hanDungMoi: finalExpiryDate.toISOString(),
                giaThang: giaThang,
                soThang: monthsToAdd,
                giaKhuyenMai: giaKhuyenMai,
                ghiChu: ghiChu,
            };
            
            showLoading(true);
            modal.classList.add('hidden');

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                 if (result.status === 'success') {
                    showNotification(`Đã tạo khách hàng mới: ${payload.tenKH}.`);
                    newCustomerForm.reset();
                    await fetchCustomers();
                } else {
                    throw new Error(result.message || 'Có lỗi xảy ra khi tạo khách hàng.');
                }
            } catch (error) {
                showNotification(`Lỗi: ${error.message}`, false);
            } finally {
                showLoading(false);
            }
        };

        const setupCurrencyInput = (input) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                const numberValue = parseCurrency(value);
                e.target.value = formatCurrency(numberValue);
            });
        };
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', fetchCustomers);
        customerSelect.addEventListener('change', (e) => displayCustomerInfo(e.target.value));
        amountInput.addEventListener('input', calculateNewExpiry);
        submitBtn.addEventListener('click', handlePaymentSubmit);

        // Modal Listeners
        addCustomerBtn.addEventListener('click', () => modal.classList.remove('hidden'));
        cancelModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        newCustomerForm.addEventListener('submit', handleNewCustomerSubmit);
        
        // Currency formatting for modal inputs
        setupCurrencyInput(amountInput);
        setupCurrencyInput(newMonthlyPriceInput);
        setupCurrencyInput(newPromoPriceInput);
        setupCurrencyInput(newInitialAmountInput);

    </script>
</body>
</html>

