<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PHI·∫æU THU INTERNET</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': '#10b981', // xanh l√° d·ªãu
            'secondary': '#f0fdf4',
            'accent': '#065f46',
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
    }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 0.7rem center;
      background-size: 1.2rem;
    }
  </style>
</head>

<body class="p-4 md:p-8 flex justify-center min-h-screen">
  <div class="w-full max-w-2xl space-y-6">
    <h1 class="text-3xl font-extrabold text-center text-gray-800 border-b-4 border-primary/60 pb-3">
      PHI·∫æU THU INTERNET
    </h1>

    <!-- Thanh th√¥ng b√°o -->
    <div id="status-message"
         class="fixed top-0 left-0 right-0 p-4 text-center z-50 transition-all duration-300 transform -translate-y-full"></div>

    <!-- KH·ªêI 1 -->
    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
      <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
        <span class="w-2 h-2 bg-primary rounded-full mr-2"></span>1. Ch·ªçn Kh√°ch H√†ng
      </h2>
      <div class="flex items-center gap-3">
        <div class="flex-grow">
          <label class="block text-sm text-gray-500 mb-1">T√™n Kh√°ch H√†ng</label>
          <select id="customer-select"
                  onchange="handleCustomerChange(event)"
                  class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-primary focus:border-primary">
            <option value="">-- Ch·ªçn Kh√°ch H√†ng --</option>
          </select>
        </div>
        <button id="btn-add-customer" onclick="openNewCustomerModal()"
                class="mt-6 p-3 rounded-xl bg-primary text-white hover:bg-green-700 shadow-md transition transform hover:scale-105 active:scale-95"
                title="Th√™m kh√°ch h√†ng m·ªõi">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
          </svg>
        </button>
      </div>
      <p id="current-tariff" class="text-sm text-gray-500 mt-2 italic"></p>
    </div>

    <!-- KH·ªêI 2 -->
    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
      <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
        <span class="w-2 h-2 bg-primary rounded-full mr-2"></span>2. C·∫≠p Nh·∫≠t Thanh To√°n
      </h2>
      <form id="payment-form" onsubmit="handlePaymentSubmit(event)">
        <label class="block text-sm text-gray-500 mb-1">S·ªë Ti·ªÅn N·ªôp (VNƒê)</label>
        <input type="text" id="amount-paid" required placeholder="Nh·∫≠p s·ªë ti·ªÅn"
               oninput="formatAndCalculate(this)"
               class="w-full bg-primary/10 border border-primary/30 rounded-lg p-3 text-lg font-semibold text-gray-800 focus:ring-primary focus:border-primary mb-4">

        <div id="projected-expiry-info" class="bg-yellow-100 p-3 rounded-lg mb-4">
          <p class="text-sm text-gray-700">S·ªë th√°ng m·ªõi (d·ª± ki·∫øn):
            <span id="new-months" class="font-bold text-primary text-lg">0</span> th√°ng
          </p>
          <p class="text-sm text-gray-700">H·∫°n d√πng m·ªõi (d·ª± ki·∫øn):
            <span id="new-expiry-date" class="font-bold text-primary text-lg">--/--/----</span>
          </p>
        </div>

        <label class="block text-sm text-gray-500 mb-1">Ghi ch√∫</label>
        <textarea id="payment-note" rows="2" placeholder="Ghi ch√∫ giao d·ªãch"
                  class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 mb-6"></textarea>

        <button type="submit" id="btn-confirm-payment" disabled
                class="w-full bg-primary text-white text-lg font-medium rounded-lg py-3 shadow-md transition transform hover:scale-[1.02] disabled:opacity-50">
          X√°c Nh·∫≠n N·ªôp Ti·ªÅn
        </button>
      </form>
    </div>

    <!-- KH·ªêI 3 -->
    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
      <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
        <span class="w-2 h-2 bg-primary rounded-full mr-2"></span>3. L·ªãch S·ª≠ G·∫ßn Nh·∫•t
      </h2>
      <div class="space-y-2 text-sm text-gray-600">
        <p>H·∫°n d√πng g·∫ßn nh·∫•t: <span id="h-expiry" class="font-semibold text-red-500">--/--/----</span></p>
        <p>Ng√†y n·ªôp (l·∫ßn tr∆∞·ªõc): <span id="h-last-paid-date">--:-- --/--/----</span></p>
        <p>S·ªë ti·ªÅn n·ªôp tr∆∞·ªõc: <span id="h-last-paid-amount">0 VNƒê</span></p>
        <p>Gi√° khuy·∫øn m·∫°i: <span id="h-promo">0 VNƒê/12 th√°ng</span></p>
        <p>Ghi ch√∫: <span id="h-note" class="italic">Ch∆∞a c√≥ ghi ch√∫.</span></p>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="new-customer-modal"
       class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50"
       onclick="closeNewCustomerModal()">
    <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-xl" onclick="event.stopPropagation()">
      <h3 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">T·∫°o Kh√°ch H√†ng M·ªõi</h3>
      <form id="new-customer-form" onsubmit="handleNewCustomerSubmit(event)">
        <div class="space-y-3">
          <input id="new-customer-name" type="text" required placeholder="T√™n Kh√°ch H√†ng"
                 class="w-full p-3 border border-gray-300 rounded-lg">
          <input id="new-customer-tariff" type="text" required placeholder="G√≥i C∆∞·ªõc (VNƒê)"
                 oninput="formatCurrencyInput(this)"
                 class="w-full p-3 border border-gray-300 rounded-lg">
          <input id="new-customer-promo" type="text" placeholder="Gi√° 12 th√°ng (VNƒê)"
                 oninput="formatCurrencyInput(this)"
                 class="w-full p-3 border border-gray-300 rounded-lg">
          <input id="new-customer-initial-payment" type="text" value="0"
                 oninput="formatCurrencyInput(this)"
                 placeholder="S·ªë ti·ªÅn n·ªôp ban ƒë·∫ßu (VNƒê)"
                 class="w-full p-3 border border-gray-300 rounded-lg">
          <input id="new-customer-expiry" type="date"
                 class="w-full p-3 border border-gray-300 rounded-lg">
          <textarea id="new-customer-note" rows="2" placeholder="Ghi ch√∫ ban ƒë·∫ßu"
                    class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
        </div>
        <div class="flex justify-end gap-3 mt-4">
          <button type="button" onclick="closeNewCustomerModal()"
                  class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">H·ªßy</button>
          <button type="submit" id="btn-create-customer"
                  class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-green-700">T·∫°o</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzBSYkXtcEdPf78aKSuSXHSp-9ukQt4NW184HFn6c-U6ltS5sNw4z8HLY5zb7g37Fld/exec'; // üîÅ Thay b·∫±ng URL c·ªßa b·∫°n
    let customerDataCache = [], selectedCustomer = null;

    const showStatus = (msg, type='success') => {
      const el = document.getElementById('status-message');
      el.textContent = msg;
      el.className = 'fixed top-0 left-0 right-0 p-4 text-center z-50 transition-all';
      if (type === 'success') el.classList.add('bg-green-600','text-white');
      else if (type === 'error') el.classList.add('bg-red-600','text-white');
      else el.classList.add('bg-yellow-500','text-white');
      el.classList.remove('-translate-y-full');
      setTimeout(()=>el.classList.add('-translate-y-full'), 4000);
    };

    const cleanCurrency = str => parseFloat((str||'').replace(/\./g,''))||0;
    const formatCurrency = n => (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")+" VNƒê";
    const formatCurrencyInput = el => {
      const val = el.value.replace(/[^0-9]/g,'');
      el.value = val ? parseInt(val).toLocaleString('vi-VN') : '';
    };

    const loadCustomerData = async () => {
      showStatus('ƒêang t·∫£i d·ªØ li·ªáu...','loading');
      try {
        const r = await fetch(API_URL);
        const data = await r.json();
        if (data.success) {
          customerDataCache = data.customers;
          const sel = document.getElementById('customer-select');
          sel.innerHTML = '<option value="">-- Ch·ªçn Kh√°ch H√†ng --</option>';
          data.customers.forEach(c=>{
            const o=document.createElement('option');
            o.value=c.tenKh; o.textContent=c.tenKh; sel.appendChild(o);
          });
          showStatus('ƒê√£ t·∫£i d·ªØ li·ªáu.','success');
        } else showStatus('L·ªói t·∫£i d·ªØ li·ªáu','error');
      } catch { showStatus('Kh√¥ng k·∫øt n·ªëi API','error'); }
    };

    const handleCustomerChange = e => {
      const n=e.target.value;
      if(!n){selectedCustomer=null;return;}
      selectedCustomer=customerDataCache.find(c=>c.tenKh===n);
      document.getElementById('current-tariff').textContent=`G√≥i c∆∞·ªõc: ${formatCurrency(selectedCustomer.goiCuoc)}`;
      document.getElementById('h-expiry').textContent=selectedCustomer.hanDungGanNhat||'--/--/----';
      document.getElementById('h-last-paid-date').textContent=selectedCustomer.ngayNopLanTruoc||'--';
      document.getElementById('h-last-paid-amount').textContent=formatCurrency(selectedCustomer.soTienNopTruoc);
      document.getElementById('h-promo').textContent=formatCurrency(selectedCustomer.giaKhuyenMai)+'/12 th√°ng';
      document.getElementById('h-note').textContent=selectedCustomer.ghiChu||'';
      document.getElementById('amount-paid').value='';
      document.getElementById('new-months').textContent='0';
      document.getElementById('new-expiry-date').textContent='--/--/----';
      document.getElementById('btn-confirm-payment').disabled=true;
    };

    const calculateNewExpiry=(months,last)=> {
      if(months<=0) return {newExpiry:'--/--/----'};
      const p=last?.split('/')||[],base=p.length?new Date(p[2],p[1]-1,p[0]):new Date();
      const newDate=new Date(base.getFullYear(),base.getMonth()+months+1,0);
      const d=("0"+newDate.getDate()).slice(-2),m=("0"+(newDate.getMonth()+1)).slice(-2);
      return {newExpiry:`${d}/${m}/${newDate.getFullYear()}`};
    };

    const formatAndCalculate=input=>{
      const v=cleanCurrency(input.value); input.value=v?formatCurrency(v).replace(' VNƒê',''):'';
      if(!selectedCustomer) return;
      const months=Math.floor(v/selectedCustomer.goiCuoc);
      const {newExpiry}=calculateNewExpiry(months,selectedCustomer.hanDungGanNhat);
      document.getElementById('new-months').textContent=months;
      document.getElementById('new-expiry-date').textContent=newExpiry;
      document.getElementById('btn-confirm-payment').disabled=months<=0;
    };

    const handlePaymentSubmit=async e=>{
      e.preventDefault();
      if(!selectedCustomer)return showStatus('Ch∆∞a ch·ªçn KH','error');
      const soTien=cleanCurrency(document.getElementById('amount-paid').value);
      const soThang=parseInt(document.getElementById('new-months').textContent);
      const hanDung=document.getElementById('new-expiry-date').textContent;
      const ghiChu=document.getElementById('payment-note').value||'';
      if(soTien<=0||soThang<=0)return showStatus('S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá','error');
      showStatus('ƒêang g·ª≠i...','loading');
      const body={action:'new_payment',tenKh:selectedCustomer.tenKh,rowIndex:selectedCustomer.rowIndex,
                  soTienNop:soTien,soThangMoi:soThang,hanDungMoi:hanDung,goiCuocHienTai:selectedCustomer.goiCuoc,
                  giaKhuyenMai:selectedCustomer.giaKhuyenMai,ghiChu};
      try{
        const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const d=await r.json();
        if(d.success){showStatus(d.message||'N·ªôp ti·ªÅn th√†nh c√¥ng','success');loadCustomerData();}
        else showStatus('L·ªói n·ªôp ti·ªÅn','error');
      }catch{showStatus('Kh√¥ng g·ª≠i ƒë∆∞·ª£c d·ªØ li·ªáu','error');}
    };

    const openNewCustomerModal=()=>{document.getElementById('new-customer-modal').classList.replace('hidden','flex');};
    const closeNewCustomerModal=()=>{document.getElementById('new-customer-modal').classList.replace('flex','hidden');};

    const handleNewCustomerSubmit=async e=>{
      e.preventDefault();
      const tenKh=document.getElementById('new-customer-name').value.trim();
      const goiCuoc=cleanCurrency(document.getElementById('new-customer-tariff').value);
      const giaKM=cleanCurrency(document.getElementById('new-customer-promo').value);
      const soTien=cleanCurrency(document.getElementById('new-customer-initial-payment').value);
      const ngay=document.getElementById('new-customer-expiry').value;
      const note=document.getElementById('new-customer-note').value||'';
      if(!tenKh||goiCuoc<=0)return showStatus('Thi·∫øu th√¥ng tin','error');
      const hanDung=ngay?ngay.split('-').reverse().join('/'):'';
      const body={action:'new_customer',tenKh,goiCuoc,giaKhuyenMai:giaKM,soTienNopBanDau:soTien,hanDungDuKien:hanDung,ghiChu:note};
      showStatus('ƒêang t·∫°o KH...','loading');
      try{
        const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const d=await r.json();
        if(d.success){showStatus(d.message,'success');closeNewCustomerModal();loadCustomerData();}
        else showStatus('L·ªói t·∫°o KH','error');
      }catch{showStatus('Kh√¥ng g·ª≠i ƒë∆∞·ª£c d·ªØ li·ªáu','error');}
    };

    window.onload=loadCustomerData;
  </script>
</body>
</html>
